# AI-PRD-Agent Bug 修复执行计划

## 项目概述
- **项目名称**: ai-prd-agent
- **技术栈**: Next.js 16 + React 19 + Prisma + SQLite/PostgreSQL
- **主要功能**: AI驱动的PRD文档生成工具

---

## 发现的Bug和问题

### 🔴 严重级别 (Critical)

#### BUG-001: 空值处理导致的运行时错误
- **文件**: `components/prd/PRDViewer.tsx` (约第240行)
- **问题描述**: 当 `techFeasibility` 为 `null` 或 `undefined` 时，直接调用 `.map()` 会导致运行时崩溃
- **影响范围**: 所有涉及技术可行性分析的PRD文档
- **复现条件**: PRD生成过程中技术可行性部分未完成时

#### BUG-002: JSON解析的空值处理不一致
- **文件**: `app/page.tsx` (约第190行)
- **问题描述**: JSON解析逻辑分散在多处，缺乏统一的解析函数
- **影响范围**: 所有JSON字段的读取

### 🟠 中等级别 (Medium)

#### BUG-003: 缺乏防抖/节流机制
- **文件**: `app/page.tsx`, `components/prd/PRDViewerEditable.tsx`
- **问题描述**: 图表生成按钮可以重复点击，可能导致重复API调用
- **影响范围**: 图表生成功能

#### BUG-004: 数组访问未检查边界
- **文件**: `components/prd/PRDViewerEditable.tsx` (约第145行)
- **问题描述**: `targetUsers.primary.map()` 未检查数组是否存在
- **影响范围**: 目标用户显示

#### BUG-005: 模型名称硬编码
- **文件**: `lib/ai.ts` (第4行)
- **问题描述**: AI模型名称硬编码在代码中，应该配置化
- **影响范围**: AI调用

### 🟡 轻微级别 (Low)

#### BUG-006: 缺乏React Error Boundary
- **文件**: 整个项目
- **问题描述**: 没有错误边界组件，组件错误会导致整个页面崩溃
- **影响范围**: 全局

#### BUG-007: 图表并发生成可能触发API限制
- **文件**: `app/api/diagrams/route.ts`
- **问题描述**: 同时生成4个图表可能触发智谱API的速率限制
- **影响范围**: 图表生成

---

## 修复执行计划

### Phase 1: 严重Bug修复 (优先级: P0)

#### 任务 1.1: 创建统一的安全访问工具函数
```typescript
// lib/utils.ts 中添加
export const safeArray = <T>(arr: T[] | null | undefined): T[] =>
  Array.isArray(arr) ? arr : [];

export const safeMap = <T, R>(
  arr: T[] | null | undefined,
  fn: (item: T, index: number) => R
): R[] => safeArray(arr).map(fn);

export const safeJsonParse = <T>(json: string | null | undefined, fallback: T): T => {
  if (!json) return fallback;
  try {
    return JSON.parse(json);
  } catch {
    return fallback;
  }
};
```

**验收标准**:
- [ ] 工具函数已添加到 `lib/utils.ts`
- [ ] 函数有完整的TypeScript类型定义
- [ ] 添加单元测试

#### 任务 1.2: 修复PRDViewer.tsx的空值处理
- 在所有 `.map()` 调用前添加空值检查
- 使用 `safeMap` 函数替换直接的 `.map()` 调用
- 添加加载状态显示

**验收标准**:
- [ ] 所有 `.map()` 调用都有空值保护
- [ ] 页面在数据缺失时不会崩溃
- [ ] 显示友好的占位符内容

#### 任务 1.3: 修复page.tsx的JSON解析
- 统一使用 `safeJsonParse` 函数
- 移除重复的 try-catch 代码块

**验收标准**:
- [ ] 所有JSON解析使用统一函数
- [ ] 代码更简洁易读

---

### Phase 2: 中等Bug修复 (优先级: P1)

#### 任务 2.1: 添加按钮防抖机制
- 为图表生成按钮添加loading状态
- 禁用重复点击
- 添加节流处理

**验收标准**:
- [ ] 按钮在loading时被禁用
- [ ] 无法重复提交相同请求
- [ ] 用户看到明确的加载指示

#### 任务 2.2: 修复PRDViewerEditable.tsx的数组访问
- 为 `targetUsers.primary` 等数组添加空值检查
- 使用 `safeMap` 函数

**验收标准**:
- [ ] 所有数组访问都有保护
- [ ] 空数组时显示友好的提示

#### 任务 2.3: 模型名称配置化
- 将模型名称移至环境变量
- 添加默认值处理

**验收标准**:
- [ ] 模型名称可通过环境变量配置
- [ ] 有合理的默认值

---

### Phase 3: 轻微Bug修复 (优先级: P2)

#### 任务 3.1: 添加React Error Boundary
- 创建 `components/ErrorBoundary.tsx`
- 在关键位置包裹组件
- 添加友好的错误提示UI

**验收标准**:
- [ ] Error Boundary组件已创建
- [ ] 包裹了关键组件
- [ ] 错误时有友好的UI反馈

#### 任务 3.2: 优化图表生成并发策略
- 实现串行或限流生成
- 添加重试机制
- 处理API限流错误

**验收标准**:
- [ ] 图表生成不会触发API限流
- [ ] 失败时有重试机制
- [ ] 错误信息清晰

---

## 执行顺序

```
┌─────────────────────────────────────────────────────────────┐
│                    Phase 1 (必须完成)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  任务 1.1   │→│  任务 1.2   │→│  任务 1.3   │         │
│  │ 安全工具函数 │  │ PRDViewer  │  │ JSON解析   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Phase 2 (推荐完成)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  任务 2.1   │  │  任务 2.2   │  │  任务 2.3   │         │
│  │ 按钮防抖    │  │ 数组访问   │  │ 模型配置   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Phase 3 (可选完成)                        │
│  ┌─────────────┐              ┌─────────────┐               │
│  │  任务 3.1   │              │  任务 3.2   │               │
│  │ Error边界   │              │ 并发优化   │               │
│  └─────────────┘              └─────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

---

## 测试计划

### 单元测试
- [ ] `safeArray`, `safeMap`, `safeJsonParse` 函数测试
- [ ] 空值处理逻辑测试

### 集成测试
- [ ] PRD生成完整流程测试
- [ ] 图表生成流程测试

### 手动测试
- [ ] 测试空数据情况下的页面显示
- [ ] 测试快速重复点击按钮
- [ ] 测试API错误情况

---

## 回归风险评估

| 修改内容 | 风险等级 | 缓解措施 |
|---------|---------|---------|
| 工具函数添加 | 低 | 新代码，不影响现有功能 |
| 空值检查添加 | 低 | 只增加保护逻辑 |
| 防抖机制 | 中 | 需要测试交互体验 |
| Error Boundary | 低 | 隔离错误，不影响正常流程 |

---

## 预计工作量

| Phase | 任务数 | 预计时间 |
|-------|-------|---------|
| Phase 1 | 3 | 核心修复 |
| Phase 2 | 3 | 功能增强 |
| Phase 3 | 2 | 可选优化 |

---

## 签署确认

- [ ] 我已阅读并理解此执行计划
- [ ] 我同意按此计划执行修复
- [ ] 我了解可能的风险

**准备执行?** 请确认后开始修复。
