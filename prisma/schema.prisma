// AI PRD Agent Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 会话：保存用户的对话会话
model Session {
  id          String   @id @default(cuid())
  title       String
  prdId       String?  @unique
  currentStep Int      @default(1)  // 当前在第几步 (1/2/3)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // NEW: Anonymous tracking fields
  anonymousId String   @default("unknown")
  sessionId   String?  @unique

  messages    Message[]
  prd         PRD?

  @@index([anonymousId])
  @@index([sessionId])
}

// 消息：保存对话历史
model Message {
  id        String   @id @default(cuid())
  role      String   // user | assistant | system
  content   String
  sessionId String
  createdAt DateTime @default(now())
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// PRD 文档：保存生成的产品需求文档
model PRD {
  id                   String   @id @default(cuid())
  sessionId            String?  @unique
  title                String
  description          String
  background           String?
  targetUsers          String   // JSON: { primary: [], secondary: [] }
  painPoints           String?  // JSON: []
  coreValue            String?  // JSON: []
  features             String   // JSON: [{ id, name, description, priority, effort, value, acceptanceCriteria }]
  successMetrics       String?  // JSON: []
  techFeasibility      String?  // JSON: { overall, challenges, recommendations }
  competitors          String?  // JSON: [{ name, features, differences }]
  // Mermaid 图表字段
  mermaidArchitecture  String?  // 系统架构图代码
  mermaidJourney       String?  // 用户旅程图代码
  mermaidFeatures      String?  // 功能模块图代码
  mermaidDataflow      String?  // 数据流图代码
  // 最终版本字段
  isFinal              Boolean  @default(false)  // 是否是最终版本
  finalContent         String?                    // 完整 PRD (Markdown)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  session              Session? @relation(fields: [sessionId], references: [id])
}

// 分析日志：记录竞品分析、可行性分析等
model AnalysisLog {
  id        String   @id @default(cuid())
  type      String   // competitor | feasibility | priority
  input     String
  output    String
  createdAt DateTime @default(now())
}

// NEW: Track all analytics events
model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventType   String   // prd_generated, prd_failed, page_view, etc.
  anonymousId String
  sessionId   String?

  // Event metadata (JSON stored as string)
  metadata    String?  // JSON string

  // Performance metrics
  duration    Int?     // for timing events

  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([anonymousId])
  @@index([createdAt])
}

// NEW: Aggregated daily statistics
model DailyStats {
  id          String   @id @default(cuid())
  date        DateTime // SQLite stores full datetime

  // User metrics (anonymous)
  uniqueUsers Int      @default(0)
  totalVisits Int      @default(0)

  // PRD metrics
  prdGenerated Int     @default(0)
  prdSuccess   Float   @default(0)  // success rate
  avgDuration  Float?  // average generation time in seconds

  // System metrics
  totalTokens  Int     @default(0)
  errorCount   Int     @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([date])
  @@index([date])
}
